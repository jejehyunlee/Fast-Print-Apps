<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Master Produk | FastPrint</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">

    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <!-- Custom CSS with cache busting -->
    <link rel="stylesheet" th:href="@{/css/style.css(v=1.1)}">
</head>

<body>

    <div id="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <div class="branding">
                    <div class="logo-text">
                        <span class="text-gold">Fast</span><span class="text-grey">Print</span>
                    </div>
                    <div class="tagline">Professional Printing Solution</div>
                </div>
            </div>

            <ul class="list-unstyled components">
                <li>
                    <a href="/dashboard">
                        <span class="icon"><i class="bi bi-grid-fill"></i></span> <span>Dashboard</span>
                    </a>
                </li>
                <li class="active">
                    <a href="/produk">
                        <span class="icon"><i class="bi bi-box-seam-fill"></i></span> <span>Master Produk</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <span class="icon"><i class="bi bi-cart-fill"></i></span> <span>Penjualan</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <span class="icon"><i class="bi bi-gear-fill"></i></span> <span>Settings</span>
                    </a>
                </li>
                <li>
                    <a href="javascript:void(0)" onclick="toggleChat()">
                        <span class="icon"><i class="bi bi-robot"></i></span> <span>AI Assistant</span><span
                            class="ai-badge">NEW</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <!-- Header Section -->
            <div class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <span class="text-secondary small fw-bold text-uppercase">Pages / Master Produk</span>
                    <h3 class="fw-bold mt-1 text-primary-dark">Product Management</h3>
                </div>

                <div class="bg-white rounded-pill px-3 py-2 shadow-sm d-flex align-items-center gap-3">
                    <div class="stat-icon m-0"
                        style="width: 32px; height: 32px; font-size: 0.9rem; background: var(--primary-soft); color: var(--primary-color);">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <span class="small fw-bold">Test Programmer|Jefri Saputra</span>
                </div>
            </div>

            <!-- Main Product Table -->
            <div class="table-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="fw-bold m-0">Produk Listing</h5>
                        <p class="text-secondary small m-0 mt-1">Kelola daftar produk Anda di sini.</p>
                    </div>
                    <button type="button" class="btn btn-primary shadow-sm" onclick="openAddModal()">
                        <i class="bi bi-plus-lg me-2"></i> Tambah Produk
                    </button>
                </div>

                <!-- Unified Table Controls -->
                <div id="tableControls">
                    <div id="filterPart" class="d-flex align-items-center gap-3">
                        <span class="filter-label">Status:</span>
                        <div class="filter-group">
                            <button type="button" class="btn-filter"
                                th:classappend="${selectedStatus == 'semua' || selectedStatus == null ? 'active' : ''}"
                                onclick="filterStatus('semua')">Semua</button>
                            <button type="button" class="btn-filter"
                                th:classappend="${selectedStatus == 'bisa dijual' ? 'active' : ''}"
                                onclick="filterStatus('bisa dijual')">Bisa Dijual</button>
                            <button type="button" class="btn-filter"
                                th:classappend="${selectedStatus == 'tidak bisa dijual' ? 'active' : ''}"
                                onclick="filterStatus('tidak bisa dijual')">Tidak Bisa Dijual</button>
                        </div>
                    </div>
                    <!-- Search part will be moved here by JS -->
                    <div id="searchPart"></div>
                </div>

                <div class="table-responsive">
                    <table id="produkTable" class="table w-100">
                        <thead>
                            <tr>
                                <th>NAMA PRODUK</th>
                                <th>KATEGORI</th>
                                <th>HARGA</th>
                                <th>STATUS</th>
                                <th class="text-end">ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="produk : ${produks}">
                                <td>
                                    <div class="product-name" th:text="${produk.namaProduk}"></div>
                                    <span class="product-id" th:text="'ID: #' + ${produk.idProduk}"></span>
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark fw-bold px-2 py-1"
                                        th:text="${produk.kategori != null ? produk.kategori.namaKategori : '-'}"></span>
                                </td>
                                <td class="fw-bold text-dark"
                                    th:text="${'Rp ' + #numbers.formatDecimal(produk.harga, 0, 'COMMA', 0, 'POINT')}">
                                </td>
                                <td>
                                    <span class="badge-custom badge-success-soft"
                                        th:if="${produk.status != null and produk.status.namaStatus == 'bisa dijual'}">
                                        <i class="bi bi-check-circle-fill"></i> Bisa Dijual
                                    </span>
                                    <span class="badge-custom badge-danger-soft"
                                        th:unless="${produk.status != null and produk.status.namaStatus == 'bisa dijual'}">
                                        <i class="bi bi-x-circle-fill"></i> Tidak Bisa Dijual
                                    </span>
                                </td>
                                <td class="text-end">
                                    <div class="d-flex justify-content-end align-items-center gap-2 flex-nowrap">
                                        <button type="button" class="btn-action edit"
                                            th:onclick="'editProduk(' + ${produk.idProduk} + ')'" title="Edit">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        <button class="btn btn-action btn-action-delete"
                                            th:onclick="'confirmDelete(' + ${produk.idProduk} + ')'" title="Hapus">
                                            <i class="bi bi-trash3-fill"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Form -->
    <div class="modal fade" id="formModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 32px; overflow: hidden;">
                <div class="modal-header border-0 p-4 pb-0">
                    <h5 class="modal-title fw-bold text-primary" id="formModalLabel" style="font-size: 1.5rem;">Tambah
                        Produk Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form th:action="@{/produk/save}" th:object="${produk}" method="post" id="productForm" novalidate>
                        <input type="hidden" id="hasErrors" th:value="${#fields.hasAnyErrors()}" />
                        <input type="hidden" id="idProduk" th:field="*{idProduk}" />

                        <div class="mb-4">
                            <label for="namaProduk" class="form-label text-secondary small fw-bold text-uppercase">NAMA
                                PRODUK</label>
                            <input type="text" class="form-control" id="namaProduk" th:field="*{namaProduk}" required
                                th:classappend="${#fields.hasErrors('namaProduk')} ? 'is-invalid' : ''"
                                placeholder="Masukkan nama produk..." style="border-radius: 12px; padding: 12px;" />
                            <div class="validation-error" th:if="${#fields.hasErrors('namaProduk')}">
                                <i class="bi bi-exclamation-circle-fill me-1"></i>
                                <span th:errors="*{namaProduk}"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label for="harga" class="form-label text-secondary small fw-bold text-uppercase">HARGA
                                    (RP)</label>
                                <input type="number" class="form-control" id="harga" th:field="*{harga}" required
                                    th:classappend="${#fields.hasErrors('harga')} ? 'is-invalid' : ''" placeholder="0"
                                    style="border-radius: 12px; padding: 12px;" />
                                <div class="validation-error" th:if="${#fields.hasErrors('harga')}">
                                    <i class="bi bi-exclamation-circle-fill me-1"></i>
                                    <span th:errors="*{harga}"></span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <label for="kategori"
                                    class="form-label text-secondary small fw-bold text-uppercase">KATEGORI</label>
                                <select class="form-select" id="kategori" th:field="*{kategori.idKategori}" required
                                    style="border-radius: 12px; padding: 12px;">
                                    <option th:each="kat : ${kategoris}" th:value="${kat.idKategori}"
                                        th:text="${kat.namaKategori}"></option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="status"
                                class="form-label text-secondary small fw-bold text-uppercase">STATUS</label>
                            <select class="form-select" id="status" th:field="*{status.idStatus}" required
                                style="border-radius: 12px; padding: 12px;">
                                <option th:each="st : ${statuses}" th:value="${st.idStatus}" th:text="${st.namaStatus}">
                                </option>
                            </select>
                        </div>

                        <div class="d-flex gap-3 mt-4">
                            <button type="button" class="btn btn-light py-3 fw-bold flex-grow-1" data-bs-dismiss="modal"
                                style="border-radius: 15px; font-size: 1.1rem; background: #f4f7fe; border: none; color: #8F9BBA;">
                                Batal
                            </button>
                            <button type="submit" class="btn btn-primary btn-save py-3 fw-bold flex-grow-2"
                                style="border-radius: 15px; font-size: 1.1rem; background: linear-gradient(135deg, #4318FF 0%, #5BC4FF 100%); border: none; box-shadow: 0 10px 20px rgba(67, 24, 255, 0.2);">
                                Simpan Data Produk
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Dependencies -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/

        $(document).ready(function () {
            var table = $('#produkTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json",
                    "paginate": {
                        "previous": "Sebelumnya",
                        "next": "Selanjutnya"
                    }
                },
                "pageLength": 5,
                "lengthMenu": [5, 10, 25, 50],
                "dom": 't<"d-flex justify-content-between align-items-center mt-4"ip>'
            });

            // Custom search input styling
            var searchInput = $('<input type="search" class="form-control" placeholder="Cari nama produk...">')
                .on('keyup', function () {
                    table.search(this.value).draw();
                });

            $('#searchPart').append('<span class="filter-label">Cari:</span>').append(searchInput);

            var formModal = new bootstrap.Modal(document.getElementById('formModal'));
            window.formModal = formModal;

            // Automatically open modal if there are validation errors
            var hasErrors = $('#hasErrors').val() === 'true';
            if (hasErrors) {
                window.formModal.show();
            }
        });

        function editProduk(id) {
            $.get('/produk/api/' + id, function (data) {
                $('#idProduk').val(data.idProduk);
                $('#namaProduk').val(data.namaProduk);
                $('#harga').val(data.harga);
                $('#kategori').val(data.kategori.idKategori);
                $('#status').val(data.status.idStatus);

                $('#formModalLabel').text('Edit Produk');
                window.formModal.show();
            }).fail(function () {
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal!',
                    text: 'Tidak dapat mengambil data produk.',
                    confirmButtonColor: '#4318FF'
                });
            });
        }

        // Reset modal when closed
        $(document).ready(function () {
            $('#formModal').on('hidden.bs.modal', function () {
                $('#productForm')[0].reset();
                $('#idProduk').val('');
                $('#formModalLabel').text('Tambah Produk Baru');
                $('.is-invalid').removeClass('is-invalid');
                $('.validation-error').fadeOut(200, function () { $(this).remove(); });
                $('#hasErrors').val('false'); // Clear the error flag
            });
        });

        function filterStatus(status) {
            window.location.href = '/produk?statusFilter=' + encodeURIComponent(status);
        }

        function openAddModal() {
            $('#formModalLabel').text('Tambah Produk Baru');
            $('#productForm')[0].reset();
            $('#idProduk').val('');
            window.formModal.show();
        }

        function openEditModal(id) {
            $('#formModalLabel').text('Edit Produk');
            $.get('/produk/api/' + id, function (data) {
                $('#idProduk').val(data.idProduk);
                $('#namaProduk').val(data.namaProduk);
                $('#harga').val(data.harga);
                if (data.kategori) $('#kategori').val(data.kategori.idKategori);
                if (data.status) $('#status').val(data.status.idStatus);
                window.formModal.show();
            }).fail(function () {
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal!',
                    text: 'Tidak dapat mengambil data produk.',
                    confirmButtonColor: '#4318FF'
                });
            });
        }

        // Success Toast
        var message = /*[[${message}]]*/ null;
        if (message) {
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });
            Toast.fire({ icon: 'success', title: message });
        }

        function confirmDelete(id) {
            Swal.fire({
                title: 'Hapus Produk?',
                text: "Data yang dihapus tidak dapat dipulihkan!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#EE5D50',
                cancelButtonColor: '#A3AED0',
                confirmButtonText: 'Ya, Hapus Data',
                cancelButtonText: 'Batalkan',
                reverseButtons: true,
                customClass: {
                    container: 'my-swal'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/produk/delete/' + id;
                }
            })
        }
        /*]]>*/
    </script>

    <!-- AI Assistant Chat Widget -->
    <div id="chat-widget-container">
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <div class="title">
                    <i class="bi bi-robot"></i>
                    <span>AI Assistant</span>
                </div>
                <div class="close-chat" onclick="toggleChat()">
                    <i class="bi bi-x-lg"></i>
                </div>
            </div>
            <div class="chat-body" id="chatBody">
                <div class="chat-message ai">
                    Halo! Saya AI Assistant FastPrint. Ada yang bisa saya bantu hari ini?
                </div>
            </div>
            <div class="typing" id="typingIndicator" style="margin-left: 20px;">AI sedang mengetik...</div>
            <div class="chat-footer">
                <form id="chatForm" onsubmit="sendMessage(event)">
                    <div class="chat-input-group">
                        <input type="text" id="userInput" placeholder="Tulis pesan..." autocomplete="off">
                        <button type="submit" class="send-btn">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="chat-toggle-btn" onclick="toggleChat()">
            <i class="bi bi-robot"></i>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/

        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.classList.toggle('active');
            if (chatWindow.classList.contains('active')) {
                document.getElementById('userInput').focus();
            }
        }

        function sendMessage(event) {
            event.preventDefault();
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;

            // Append user message
            appendMessage('user', message);
            input.value = '';

            // Show typing indicator
            const typing = document.getElementById('typingIndicator');
            typing.style.display = 'block';

            // Scroll to bottom
            const chatBody = document.getElementById('chatBody');
            chatBody.scrollTop = chatBody.scrollHeight;

            // Send to backend
            fetch('/api/ai/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            })
                .then(response => response.json())
                .then(data => {
                    typing.style.display = 'none';
                    appendMessage('ai', data.response);
                })
                .catch(error => {
                    typing.style.display = 'none';
                    appendMessage('ai', 'Maaf, terjadi kesalahan pada koneksi.');
                    console.error('Error:', error);
                });
        }

        function formatMessage(text) {
            if (!text) return '';

            // Configure marked for safe parsing
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });

            return marked.parse(text);
        }

        function appendMessage(sender, text) {
            const chatBody = document.getElementById('chatBody');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message ' + sender;

            if (sender === 'ai') {
                messageDiv.innerHTML = formatMessage(text);
            } else {
                messageDiv.innerText = text;
            }

            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        /*]]>*/
    </script>
</body>

</html>