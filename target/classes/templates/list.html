<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Master Produk | FastPrint</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">

    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>

    <div id="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <span class="logo-icon">üí†</span> fast**print**
            </div>

            <ul class="list-unstyled components">
                <li>
                    <a href="/dashboard">
                        <span class="icon">üè†</span> Dashboard
                    </a>
                </li>
                <li class="active">
                    <a href="/produk">
                        <span class="icon">üì¶</span> Master Produk
                    </a>
                </li>
                <li>
                    <a href="#">
                        <span class="icon">üõí</span> Penjualan
                    </a>
                </li>
                <li>
                    <a href="#">
                        <span class="icon">‚öôÔ∏è</span> Settings
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <!-- Header Section -->
            <div class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <span class="text-secondary small">Pages / Master Produk</span>
                    <h3 class="fw-bold mt-1 text-primary-dark">Master Produk</h3>
                </div>

                <div class="bg-white rounded-pill px-3 py-2 shadow-sm d-flex align-items-center gap-2">
                    <span class="badge rounded-circle bg-light text-primary p-2">üë§</span>
                    <span class="small fw-semibold">Tes Programmer</span>
                </div>
            </div>

            <!-- Main Product Table -->
            <div class="table-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold m-0">Produk Listing</h5>
                    <div class="d-flex gap-2">
                        <select class="form-select shadow-sm" id="statusFilterDropdown"
                            onchange="filterStatus(this.value)" style="border-radius: 12px; width: 200px;">
                            <option value="semua" th:selected="${selectedStatus == 'semua'}">Semua Status</option>
                            <option value="bisa dijual" th:selected="${selectedStatus == 'bisa dijual'}">Bisa Dijual
                            </option>
                            <option value="tidak bisa dijual" th:selected="${selectedStatus == 'tidak bisa dijual'}">
                                Tidak Bisa Dijual</option>
                        </select>
                        <button type="button" class="btn btn-primary shadow-sm" onclick="openAddModal()">
                            + Tambah Produk
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table id="produkTable" class="table w-100">
                        <thead>
                            <tr>
                                <th>NAMA PRODUK</th>
                                <th>KATEGORI</th>
                                <th>HARGA</th>
                                <th>STATUS</th>
                                <th class="text-end">ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="produk : ${produks}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="fw-bold text-dark" th:text="${produk.namaProduk}"></div>
                                    </div>
                                    <small class="text-muted" th:text="'ID: #' + ${produk.idProduk}"></small>
                                </td>
                                <td th:text="${produk.kategori != null ? produk.kategori.namaKategori : '-'}"></td>
                                <td class="fw-bold text-primary"
                                    th:text="${'Rp ' + #numbers.formatDecimal(produk.harga, 0, 'COMMA', 0, 'POINT')}">
                                </td>
                                <td>
                                    <span class="badge badge-custom badge-success-soft"
                                        th:if="${produk.status != null and produk.status.namaStatus == 'bisa dijual'}">
                                        <i class="bi bi-patch-check-fill"></i> Bisa Dijual
                                    </span>
                                    <span class="badge badge-custom badge-danger-soft"
                                        th:unless="${produk.status != null and produk.status.namaStatus == 'bisa dijual'}">
                                        <i class="bi bi-exclamation-triangle-fill"></i> Tidak Bisa
                                    </span>
                                </td>
                                <td class="text-end">
                                    <div class="d-flex justify-content-end align-items-center gap-2 flex-nowrap">
                                        <button class="btn btn-action btn-action-edit"
                                            th:onclick="'openEditModal(' + ${produk.idProduk} + ')'" title="Edit">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                        <button class="btn btn-action btn-action-delete"
                                            th:onclick="'confirmDelete(' + ${produk.idProduk} + ')'" title="Hapus">
                                            <i class="bi bi-trash3-fill"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Form -->
    <div class="modal fade" id="formModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow" style="border-radius: 20px;">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold" id="formModalLabel">Tambah Produk</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form th:action="@{/produk/save}" th:object="${produk}" method="post" id="productForm">
                        <input type="hidden" id="idProduk" th:field="*{idProduk}" />

                        <div class="mb-3">
                            <label for="namaProduk" class="form-label text-secondary small fw-bold">NAMA PRODUK</label>
                            <input type="text" class="form-control" id="namaProduk" th:field="*{namaProduk}" required
                                style="border-radius: 12px; height: 45px;" />
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="harga" class="form-label text-secondary small fw-bold">HARGA (RP)</label>
                                <input type="number" class="form-control" id="harga" th:field="*{harga}" required
                                    style="border-radius: 12px; height: 45px;" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="kategori" class="form-label text-secondary small fw-bold">KATEGORI</label>
                                <select class="form-select" id="kategori" th:field="*{kategori.idKategori}"
                                    style="border-radius: 12px; height: 45px;">
                                    <option th:each="kat : ${kategoris}" th:value="${kat.idKategori}"
                                        th:text="${kat.namaKategori}"></option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="status" class="form-label text-secondary small fw-bold">STATUS</label>
                            <select class="form-select" id="status" th:field="*{status.idStatus}"
                                style="border-radius: 12px; height: 45px;">
                                <option th:each="stat : ${statuses}" th:value="${stat.idStatus}"
                                    th:text="${stat.namaStatus}"></option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-3 rounded-4 fw-bold">Simpan Data</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Dependencies -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/

        $(document).ready(function () {
            $('#produkTable').DataTable({
                "language": { "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json" },
                "pageLength": 5,
                "lengthMenu": [5, 10, 25],
                "dom": '<"d-flex justify-content-between align-items-center mb-3"f>t<"d-flex justify-content-between align-items-center mt-3"ip>'
            });

            var formModal = new bootstrap.Modal(document.getElementById('formModal'));
            window.formModal = formModal;
        });

        function filterStatus(status) {
            window.location.href = '/produk?statusFilter=' + encodeURIComponent(status);
        }

        function openAddModal() {
            $('#formModalLabel').text('Tambah Produk Baru');
            $('#productForm')[0].reset();
            $('#idProduk').val('');
            window.formModal.show();
        }

        function openEditModal(id) {
            $('#formModalLabel').text('Edit Produk');
            $.get('/produk/api/' + id, function (data) {
                $('#idProduk').val(data.idProduk);
                $('#namaProduk').val(data.namaProduk);
                $('#harga').val(data.harga);
                if (data.kategori) $('#kategori').val(data.kategori.idKategori);
                if (data.status) $('#status').val(data.status.idStatus);
                window.formModal.show();
            }).fail(function () {
                Swal.fire('Error', 'Gagal mengambil data produk', 'error');
            });
        }

        // Success Toast
        var message = /*[[${message}]]*/ null;
        if (message) {
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });
            Toast.fire({ icon: 'success', title: message });
        }

        function confirmDelete(id) {
            Swal.fire({
                title: 'Hapus Produk?',
                text: "Data tidak bisa dikembalikan!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#EE5D50',
                cancelButtonColor: '#A3AED0',
                confirmButtonText: 'Ya, Hapus'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/produk/delete/' + id;
                }
            })
        }
        /*]]>*/
    </script>

</body>

</html>